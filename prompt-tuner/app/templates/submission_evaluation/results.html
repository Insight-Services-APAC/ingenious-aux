{% extends "base.html" %}

{% block title %}Evaluation Results - Submission over Criteria Platform{% endblock %}

{% block content %}
<div class="container-fluid py-4" x-data="resultsManager">
    <div class="row">
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1 text-gray-800">Evaluation Results</h1>
                    <p class="text-muted mb-0">View and analyze evaluation results from previous runs</p>
                </div>
                <div>
                    <button class="btn btn-primary" @click="loadFromFile">
                        <i class="bi bi-upload me-1"></i>Load Results File
                    </button>
                    <input type="file" ref="fileInput" @change="handleFileUpload" accept=".json" class="d-none">
                </div>
            </div>
        </div>
    </div>

    <!-- Results Display -->
    <div class="row" x-show="results.length === 0">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="bi bi-graph-up fs-1 text-muted"></i>
                    <h5 class="mt-3 mb-2">No Results Available</h5>
                    <p class="text-muted mb-4">Upload a results file or run an evaluation to see results here.</p>
                    <button class="btn btn-primary me-2" @click="loadFromFile">
                        <i class="bi bi-upload me-1"></i>Load Results File
                    </button>
                    <a href="{{ url_for('submission_evaluation.evaluate') }}" class="btn btn-outline-primary">
                        <i class="bi bi-play-circle me-1"></i>Run New Evaluation
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Results List -->
    <div class="row" x-show="results.length > 0">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Evaluation Results</h6>
                        <span class="badge bg-primary" x-text="results.length + ' results'"></span>
                    </div>
                </div>
                <div class="card-body">
                    <template x-for="(result, index) in results" :key="result.evaluation_id">
                        <div class="card mb-3 border-start border-success border-1">
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6 class="mb-1">Evaluation ID</h6>
                                        <p class="text-muted mb-0" x-text="result.evaluation_id"></p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="mb-1">Thread ID</h6>
                                        <p class="text-muted mb-0" x-text="result.thread_id"></p>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6 class="mb-1">Token Count</h6>
                                        <p class="text-muted mb-0" x-text="result.token_count"></p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="mb-1">Timestamp</h6>
                                        <p class="text-muted mb-0" x-text="formatDate(result.timestamp)"></p>
                                    </div>
                                </div>

                                <div class="row mb-3" x-show="result.summary">
                                    <div class="col-12">
                                        <h6 class="mb-2">Summary</h6>
                                        <div class="bg-light p-3 rounded">
                                            <pre class="mb-0" x-text="result.summary"
                                                style="white-space: pre-wrap; font-size: 0.9em;"></pre>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-3" x-show="result.evaluations && result.evaluations.length > 0">
                                    <div class="col-12">
                                        <h6 class="mb-2">Agent Evaluations</h6>
                                        <div class="accordion" :id="'accordion' + index">
                                            <template x-for="(evaluation, evalIndex) in result.evaluations"
                                                :key="evaluation.agent">
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header">
                                                        <button class="accordion-button collapsed" type="button"
                                                            data-bs-toggle="collapse"
                                                            :data-bs-target="'#collapse' + index + '_' + evalIndex">
                                                            <span x-text="evaluation.agent"></span>
                                                            <span class="badge bg-secondary ms-2"
                                                                x-text="evaluation.tokens + ' tokens'"></span>
                                                        </button>
                                                    </h2>
                                                    <div :id="'collapse' + index + '_' + evalIndex"
                                                        class="accordion-collapse collapse"
                                                        :data-bs-parent="'#accordion' + index">
                                                        <div class="accordion-body">
                                                            <pre class="mb-0" x-text="evaluation.content"
                                                                style="white-space: pre-wrap; font-size: 0.85em;"></pre>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12">
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-sm btn-outline-primary"
                                                @click="downloadResult(result)">
                                                <i class="bi bi-download me-1"></i>Download
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @click="removeResult(index)">
                                                <i class="bi bi-trash me-1"></i>Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Tools -->
    <div class="row mt-4" x-show="results.length > 1">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0">Analysis Tools</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Token Usage Analysis</h6>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Total Tokens Used:</span>
                                    <strong x-text="totalTokens"></strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Average per Evaluation:</span>
                                    <strong x-text="averageTokens"></strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Evaluation Statistics</h6>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Total Evaluations:</span>
                                    <strong x-text="results.length"></strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Most Recent:</span>
                                    <strong x-text="mostRecentDate"></strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <button class="btn btn-primary" @click="exportAllResults">
                                <i class="bi bi-file-earmark-zip me-1"></i>Export All Results
                            </button>
                            <button class="btn btn-outline-secondary ms-2" @click="clearAllResults">
                                <i class="bi bi-trash me-1"></i>Clear All Results
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('resultsManager', () => ({
            results: [],

            get totalTokens() {
                return this.results.reduce((total, result) => total + (result.token_count || 0), 0);
            },

            get averageTokens() {
                if (this.results.length === 0) return 0;
                return Math.round(this.totalTokens / this.results.length);
            },

            get mostRecentDate() {
                if (this.results.length === 0) return 'N/A';
                const recent = this.results.reduce((latest, result) => {
                    const resultDate = new Date(result.timestamp || 0);
                    const latestDate = new Date(latest.timestamp || 0);
                    return resultDate > latestDate ? result : latest;
                });
                return this.formatDate(recent.timestamp);
            },

            init() {
                this.loadFromLocalStorage();
            },

            loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('evaluation-results');
                    if (saved) {
                        this.results = JSON.parse(saved);
                    }
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                }
            },

            saveToLocalStorage() {
                try {
                    localStorage.setItem('evaluation-results', JSON.stringify(this.results));
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                }
            },

            loadFromFile() {
                this.$refs.fileInput.click();
            },

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const result = JSON.parse(e.target.result);
                        this.addResult(result);
                        Utils.showToast('Results loaded successfully', 'success');
                    } catch (error) {
                        console.error('Error parsing file:', error);
                        Utils.showToast('Error parsing results file', 'danger');
                    }
                };
                reader.readAsText(file);
            },

            addResult(result) {
                // Check if result already exists
                const existingIndex = this.results.findIndex(r => r.evaluation_id === result.evaluation_id);
                if (existingIndex !== -1) {
                    this.results[existingIndex] = result;
                } else {
                    this.results.unshift(result);
                }
                this.saveToLocalStorage();
            },

            removeResult(index) {
                this.results.splice(index, 1);
                this.saveToLocalStorage();
                Utils.showToast('Result removed', 'success');
            },

            downloadResult(result) {
                const dataStr = JSON.stringify(result, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

                const exportFileDefaultName = `evaluation_${result.evaluation_id}_${this.formatDate(result.timestamp, true)}.json`;

                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();

                Utils.showToast('Result downloaded', 'success');
            },

            exportAllResults() {
                const dataStr = JSON.stringify(this.results, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

                const exportFileDefaultName = `all_evaluation_results_${new Date().toISOString().split('T')[0]}.json`;

                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();

                Utils.showToast('All results exported', 'success');
            },

            clearAllResults() {
                if (confirm('Are you sure you want to clear all results? This action cannot be undone.')) {
                    this.results = [];
                    this.saveToLocalStorage();
                    Utils.showToast('All results cleared', 'success');
                }
            },

            formatDate(timestamp, forFilename = false) {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp);
                if (forFilename) {
                    return date.toISOString().split('T')[0];
                }
                return date.toLocaleString();
            }
        }));
    });

    // Auto-save results from evaluation page
    window.addEventListener('evaluationComplete', (event) => {
        if (window.Alpine && window.Alpine.store) {
            const resultsManager = document.querySelector('[x-data="resultsManager"]');
            if (resultsManager && resultsManager._x_dataStack) {
                resultsManager._x_dataStack[0].addResult(event.detail);
            }
        }
    });
</script>
{% endblock %}