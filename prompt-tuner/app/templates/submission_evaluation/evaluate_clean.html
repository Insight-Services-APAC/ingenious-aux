{% extends "base.html" %}

{% block title %}Submission over Criteria - Submission over Criteria Platform{% endblock %}

{% block content %}
<div class="container-fluid py-4" x-data="evaluationManager">
    <div class="row">
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1 text-gray-800">Submission over Criteria</h1>
                    <p class="text-muted mb-0">Evaluate submissions using AI-powered multi-agent analysis</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary" @click="loadSampleData" :disabled="loading">
                        <i class="bi bi-database me-1"></i>Load Sample Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0">Configuration</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="revisionSelect" class="form-label">Prompt Revision</label>
                            <select id="revisionSelect" class="form-select" x-model="config.revision_id">
                                <option value="">Select a revision...</option>
                                <option value="v1.2">v1.2</option>
                                <option value="v1.3">v1.3</option>
                                <option value="latest">latest</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="evaluationId" class="form-label">Evaluation ID</label>
                            <input type="text" id="evaluationId" class="form-control" x-model="config.identifier"
                                placeholder="Enter evaluation identifier...">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Evaluation Criteria -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0">Evaluation Criteria</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <label for="criteriaText" class="form-label">Criteria Description</label>
                            <textarea id="criteriaText" class="form-control" rows="4" x-model="config.criteria.criteria"
                                placeholder="Enter detailed evaluation criteria..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submissions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Submissions</h6>
                        <button class="btn btn-sm btn-outline-primary" @click="addSubmission">
                            <i class="bi bi-plus-circle me-1"></i>Add Submission
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div x-show="config.submissions.length === 0" class="text-center py-4">
                        <i class="bi bi-plus-circle fs-1 text-muted"></i>
                        <p class="mt-2 text-muted">No submissions added yet</p>
                        <button class="btn btn-outline-primary" @click="addSubmission">
                            Add Your First Submission
                        </button>
                    </div>

                    <div x-show="config.submissions.length > 0">
                        <template x-for="(submission, index) in config.submissions" :key="submission.id">
                            <div class="card mb-3 border-start border-primary border-1">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12 mb-3">
                                            <label :for="'submissionTitle' + index" class="form-label">Title</label>
                                            <input type="text" :id="'submissionTitle' + index" class="form-control"
                                                x-model="submission.title" placeholder="Enter submission title...">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label :for="'submissionAuthor' + index" class="form-label">Author</label>
                                            <input type="text" :id="'submissionAuthor' + index" class="form-control"
                                                x-model="submission.author" placeholder="Enter author name...">
                                        </div>
                                        <div class="col-md-6">
                                            <label :for="'submissionDepartment' + index"
                                                class="form-label">Department</label>
                                            <input type="text" :id="'submissionDepartment' + index" class="form-control"
                                                x-model="submission.metadata.department"
                                                placeholder="Enter department...">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <label :for="'submissionContent' + index" class="form-label">Content</label>
                                            <textarea :id="'submissionContent' + index" class="form-control" rows="4"
                                                x-model="submission.content"
                                                placeholder="Enter submission content..."></textarea>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <button class="btn btn-sm btn-outline-danger"
                                                @click="removeSubmission(index)">
                                                <i class="bi bi-trash me-1"></i>Remove Submission
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Evaluation Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Ready to Evaluate</h6>
                            <p class="text-muted mb-0">
                                <span x-text="config.submissions.length"></span> submissions configured
                            </p>
                        </div>
                        <div>
                            <button class="btn btn-success btn-lg" @click="runEvaluation"
                                :disabled="!canRunEvaluation || loading">
                                <i class="bi bi-play-circle me-2"></i>
                                <span x-show="!loading">Run Evaluation</span>
                                <span x-show="loading">Running...</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div class="row" x-show="evaluationResult">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Evaluation Results</h6>
                    </div>
                </div>
                <div class="card-body">
                    <div x-show="evaluationResult.summary" class="mb-4">
                        <h6>Summary</h6>
                        <div class="bg-light p-3 rounded">
                            <pre class="mb-0" x-text="evaluationResult.summary" style="white-space: pre-wrap;"></pre>
                        </div>
                    </div>

                    <div x-show="evaluationResult.evaluations && evaluationResult.evaluations.length > 0">
                        <h6>Agent Evaluations</h6>
                        <div class="accordion" id="evaluationAccordion">
                            <template x-for="(evaluation, index) in evaluationResult.evaluations"
                                :key="evaluation.agent">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" :data-bs-target="'#collapse' + index">
                                            <span x-text="evaluation.agent"></span>
                                            <span class="badge bg-secondary ms-2"
                                                x-text="evaluation.tokens + ' tokens'"></span>
                                        </button>
                                    </h2>
                                    <div :id="'collapse' + index" class="accordion-collapse collapse"
                                        data-bs-parent="#evaluationAccordion">
                                        <div class="accordion-body">
                                            <pre class="mb-0" x-text="evaluation.content"
                                                style="white-space: pre-wrap;"></pre>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">
                            Evaluation ID: <span x-text="evaluationResult.evaluation_id"></span> |
                            Total Tokens: <span x-text="evaluationResult.token_count"></span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('evaluationManager', () => ({
            config: {
                revision_id: 'v1.2',
                identifier: 'eval-' + Date.now(),
                submissions: [],
                criteria: {
                    criteria: '',
                    weight: 1.0  // Default weight set in background
                },
                additional_context: 'Standard evaluation context'  // Default context set in background
            },
            evaluationResult: null,
            loading: false,

            init() {
                // Initialize the evaluation manager
            },

            get canRunEvaluation() {
                return this.config.revision_id &&
                    this.config.identifier &&
                    this.config.submissions.length > 0 &&
                    this.config.criteria.criteria.trim();
            },

            addSubmission() {
                this.config.submissions.push({
                    id: 'sub_' + (this.config.submissions.length + 1).toString().padStart(3, '0'),
                    title: '',
                    author: '',
                    content: '',
                    metadata: {
                        department: '',
                        submission_date: new Date().toISOString().split('T')[0]
                    }
                });
            },

            removeSubmission(index) {
                this.config.submissions.splice(index, 1);
            },

            loadSampleData() {
                this.config.submissions = [
                    {
                        id: 'sub_001',
                        title: 'Comprehensive Recycling Program',
                        author: 'Jane Smith',
                        content: 'We should implement a comprehensive recycling program that includes separate bins for different materials, educational workshops for employees, and partnerships with local recycling facilities. This would reduce our environmental impact and demonstrate corporate responsibility. Furthermore, we can track the amount of waste recycled to measure the program\'s effectiveness and make adjustments as needed. Regular audits of our waste management practices will help identify areas for improvement and ensure compliance with environmental regulations.',
                        metadata: {
                            department: 'Environmental Affairs',
                            submission_date: '2024-01-15',
                            word_count: 45
                        }
                    },
                    {
                        id: 'sub_002',
                        title: 'More Trash Cans',
                        author: 'Bob Johnson',
                        content: 'A simple solution would be to just put more trash cans around the office. This would make it easier for people to throw away their waste and keep the office clean. Additionally, we could implement a color-coded system to differentiate between recyclable and non-recyclable waste. Clear signage and employee training would be essential to ensure the system is used correctly and effectively.',
                        metadata: {
                            department: 'Facilities',
                            submission_date: '2024-01-16',
                            word_count: 25
                        }
                    },
                    {
                        id: 'sub_003',
                        title: 'Energy-Efficient Lighting Upgrade',
                        author: 'Alice Brown',
                        content: 'Upgrading our office lighting to energy-efficient LED fixtures would significantly reduce our energy consumption and lower our electricity bills. This initiative would involve replacing all existing fluorescent lights with LEDs, which consume up to 75% less energy and last much longer. We should also consider installing motion sensors in low-traffic areas to further conserve energy. A detailed cost-benefit analysis should be conducted to assess the financial viability and environmental impact of this project.',
                        metadata: {
                            department: 'Operations',
                            submission_date: '2024-02-01',
                            word_count: 60
                        }
                    },
                    {
                        id: 'sub_004',
                        title: 'Sustainable Procurement Policy',
                        author: 'Charlie Wilson',
                        content: 'We need to establish a sustainable procurement policy that prioritizes environmentally friendly products and suppliers. This policy should include guidelines for purchasing recycled paper, biodegradable cleaning supplies, and sustainably sourced office furniture. We should also encourage suppliers to adopt sustainable practices and provide transparent information about the environmental impact of their products. Regular reviews of our procurement practices will help ensure we are meeting our sustainability goals and minimizing our environmental footprint. Training for procurement staff will be essential to implement this policy effectively.',
                        metadata: {
                            department: 'Purchasing',
                            submission_date: '2024-02-15',
                            word_count: 70
                        }
                    }
                ];

                this.config.criteria.criteria = 'Evaluate submissions based on environmental impact, feasibility, cost-effectiveness, and innovation. Consider the depth of analysis and practical implementation steps.';
                this.config.criteria.weight = 1.0; // Always use default weight
                this.config.additional_context = 'Standard evaluation context'; // Always use default context

                Utils.showToast('Sample data loaded', 'success');
            },

            async runEvaluation() {
                if (!this.canRunEvaluation) {
                    Utils.showToast('Please complete all required fields', 'warning');
                    return;
                }

                this.loading = true;

                try {
                    // Add word count to metadata
                    this.config.submissions.forEach(submission => {
                        submission.metadata.word_count = submission.content.split(/\s+/).length;
                    });

                    const requestData = {
                        ...this.config,
                        user_id: 'flask-user',
                        thread_id: 'thread-' + this.config.identifier,
                        timestamp: new Date().toISOString()
                    };

                    const response = await fetch('/submission-evaluation/api/evaluate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    this.evaluationResult = await response.json();
                    Utils.showToast('Evaluation completed successfully', 'success');

                } catch (error) {
                    console.error('Error running evaluation:', error);
                    Utils.showToast('Failed to run evaluation: ' + error.message, 'danger');
                } finally {
                    this.loading = false;
                }
            }
        }));
    });
</script>
{% endblock %}