{% extends "base.html" %}

{% block title %}Diagnostics - Ingenious AI Platform{% endblock %}

{% block content %}
<div class="container-fluid py-4" x-data="diagnosticsManager">
    <div class="row">
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1 text-gray-800">System Diagnostics</h1>
                    <p class="text-muted mb-0">Monitor system health and performance</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary" @click="refreshDiagnostics" :disabled="loading">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status Overview -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-heart-pulse fs-1" :class="getStatusColor('api')"></i>
                    </div>
                    <h6 class="card-title">API Health</h6>
                    <p class="card-text" x-text="healthStatus.api_status || 'Checking...'"></p>
                    <span class="badge" :class="getStatusBadge('api')"
                        x-text="healthStatus.api_status || 'Unknown'"></span>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-database fs-1" :class="getStatusColor('database')"></i>
                    </div>
                    <h6 class="card-title">Database</h6>
                    <p class="card-text" x-text="healthStatus.database_status || 'Checking...'"></p>
                    <span class="badge" :class="getStatusBadge('database')"
                        x-text="healthStatus.database_status || 'Unknown'"></span>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-cpu fs-1" :class="getStatusColor('system')"></i>
                    </div>
                    <h6 class="card-title">System</h6>
                    <p class="card-text" x-text="healthStatus.system_status || 'Checking...'"></p>
                    <span class="badge" :class="getStatusBadge('system')"
                        x-text="healthStatus.system_status || 'Unknown'"></span>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-diagram-3 fs-1" :class="getStatusColor('workflows')"></i>
                    </div>
                    <h6 class="card-title">Workflows</h6>
                    <p class="card-text" x-text="healthStatus.workflows_status || 'Checking...'"></p>
                    <span class="badge" :class="getStatusBadge('workflows')"
                        x-text="healthStatus.workflows_status || 'Unknown'"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Diagnostics -->
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0">Detailed Diagnostics</h6>
                </div>
                <div class="card-body">
                    <!-- Loading State -->
                    <div x-show="loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading diagnostics...</p>
                    </div>

                    <!-- Error State -->
                    <div x-show="error && !loading" class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span x-text="error"></span>
                    </div>

                    <!-- Diagnostics Info -->
                    <div x-show="!loading && !error">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>System Information</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Version:</strong> <span x-text="diagnostics.version || 'N/A'"></span>
                                    </li>
                                    <li><strong>Environment:</strong> <span
                                            x-text="diagnostics.environment || 'N/A'"></span></li>
                                    <li><strong>Uptime:</strong> <span x-text="diagnostics.uptime || 'N/A'"></span></li>
                                    <li><strong>Memory Usage:</strong> <span
                                            x-text="diagnostics.memory_usage || 'N/A'"></span></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>API Information</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Endpoints:</strong> <span
                                            x-text="diagnostics.endpoint_count || 'N/A'"></span></li>
                                    <li><strong>Last Request:</strong> <span
                                            x-text="formatDate(diagnostics.last_request) || 'N/A'"></span></li>
                                    <li><strong>Total Requests:</strong> <span
                                            x-text="diagnostics.total_requests || 'N/A'"></span></li>
                                    <li><strong>Error Rate:</strong> <span
                                            x-text="diagnostics.error_rate || 'N/A'"></span></li>
                                </ul>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <h6>Configuration</h6>
                                <div class="accordion" id="configAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#configCollapse">
                                                View Configuration Details
                                            </button>
                                        </h2>
                                        <div id="configCollapse" class="accordion-collapse collapse"
                                            data-bs-parent="#configAccordion">
                                            <div class="accordion-body">
                                                <pre class="bg-light p-3 rounded"><code
                                                        x-text="formatJSON(diagnostics.configuration)"></code></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row" x-show="diagnostics.dependencies">
                            <div class="col-12">
                                <h6>Dependencies</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Service</th>
                                                <th>Status</th>
                                                <th>Version</th>
                                                <th>Response Time</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="dep in diagnostics.dependencies" :key="dep.name">
                                                <tr>
                                                    <td x-text="dep.name"></td>
                                                    <td>
                                                        <span class="badge"
                                                            :class="dep.status === 'healthy' ? 'bg-success' : 'bg-danger'"
                                                            x-text="dep.status"></span>
                                                    </td>
                                                    <td x-text="dep.version || 'N/A'"></td>
                                                    <td x-text="dep.response_time || 'N/A'"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0">Health Check</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" @click="runHealthCheck" :disabled="healthCheckRunning">
                            <span x-show="!healthCheckRunning">
                                <i class="bi bi-play-circle me-1"></i>Run Health Check
                            </span>
                            <span x-show="healthCheckRunning">
                                <div class="spinner-border spinner-border-sm me-1"></div>
                                Running...
                            </span>
                        </button>

                        <button class="btn btn-outline-secondary" @click="downloadDiagnostics">
                            <i class="bi bi-download me-1"></i>Download Report
                        </button>

                        <button class="btn btn-outline-info" @click="viewLogs">
                            <i class="bi bi-file-text me-1"></i>View Logs
                        </button>
                    </div>

                    <div class="mt-3" x-show="healthCheckResult">
                        <h6>Health Check Result</h6>
                        <div class="alert" :class="healthCheckResult.success ? 'alert-success' : 'alert-danger'">
                            <i class="bi me-2"
                                :class="healthCheckResult.success ? 'bi-check-circle' : 'bi-x-circle'"></i>
                            <span x-text="healthCheckResult.message"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mt-3">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0">System Metrics</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="fw-semibold fs-4" x-text="metrics.cpu_usage || 'N/A'"></div>
                            <div class="text-muted small">CPU Usage</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="fw-semibold fs-4" x-text="metrics.memory_usage || 'N/A'"></div>
                            <div class="text-muted small">Memory</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="fw-semibold fs-4" x-text="metrics.disk_usage || 'N/A'"></div>
                            <div class="text-muted small">Disk Usage</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="fw-semibold fs-4" x-text="metrics.network_io || 'N/A'"></div>
                            <div class="text-muted small">Network I/O</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('diagnosticsManager', () => ({
            healthStatus: {},
            diagnostics: {},
            metrics: {},
            healthCheckResult: null,
            loading: false,
            healthCheckRunning: false,
            error: null,

            async init() {
                await this.loadDiagnostics();
                this.startMetricsUpdater();
            },

            async loadDiagnostics() {
                this.loading = true;
                this.error = null;

                try {
                    // Load health status
                    const healthResponse = await fetch('/diagnostics/api/health');
                    if (healthResponse.ok) {
                        this.healthStatus = await healthResponse.json();
                    } else {
                        this.healthStatus = { api_status: 'offline' };
                    }

                    // Load diagnostic information
                    const diagResponse = await fetch('/diagnostics/api/diagnostic');
                    if (diagResponse.ok) {
                        this.diagnostics = await diagResponse.json();
                    } else {
                        this.diagnostics = {};
                    }

                    // Mock metrics for display
                    this.metrics = {
                        cpu_usage: Math.floor(Math.random() * 100) + '%',
                        memory_usage: Math.floor(Math.random() * 100) + '%',
                        disk_usage: Math.floor(Math.random() * 100) + '%',
                        network_io: Math.floor(Math.random() * 1000) + ' KB/s'
                    };

                } catch (error) {
                    console.error('Error loading diagnostics:', error);
                    this.error = 'Failed to load diagnostics';
                    Utils.showToast('Failed to load diagnostics', 'danger');
                } finally {
                    this.loading = false;
                }
            },

            async refreshDiagnostics() {
                await this.loadDiagnostics();
                Utils.showToast('Diagnostics refreshed', 'success');
            },

            async runHealthCheck() {
                this.healthCheckRunning = true;
                this.healthCheckResult = null;

                try {
                    const response = await fetch('/diagnostics/api/health');
                    const result = await response.json();

                    this.healthCheckResult = {
                        success: response.ok,
                        message: response.ok ? 'All systems operational' : 'Some systems have issues'
                    };

                    // Update health status
                    this.healthStatus = result;

                } catch (error) {
                    console.error('Error running health check:', error);
                    this.healthCheckResult = {
                        success: false,
                        message: 'Health check failed'
                    };
                } finally {
                    this.healthCheckRunning = false;
                }
            },

            downloadDiagnostics() {
                const report = {
                    timestamp: new Date().toISOString(),
                    health_status: this.healthStatus,
                    diagnostics: this.diagnostics,
                    metrics: this.metrics
                };

                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `diagnostics-report-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            viewLogs() {
                Utils.showToast('Logs viewing feature coming soon', 'info');
            },

            startMetricsUpdater() {
                // Update metrics every 30 seconds
                setInterval(() => {
                    this.metrics = {
                        cpu_usage: Math.floor(Math.random() * 100) + '%',
                        memory_usage: Math.floor(Math.random() * 100) + '%',
                        disk_usage: Math.floor(Math.random() * 100) + '%',
                        network_io: Math.floor(Math.random() * 1000) + ' KB/s'
                    };
                }, 30000);
            },

            getStatusColor(type) {
                const status = this.healthStatus[`${type}_status`];
                const colorMap = {
                    'healthy': 'text-success',
                    'online': 'text-success',
                    'operational': 'text-success',
                    'offline': 'text-danger',
                    'error': 'text-danger',
                    'warning': 'text-warning'
                };

                return colorMap[status?.toLowerCase()] || 'text-muted';
            },

            getStatusBadge(type) {
                const status = this.healthStatus[`${type}_status`];
                const badgeMap = {
                    'healthy': 'bg-success',
                    'online': 'bg-success',
                    'operational': 'bg-success',
                    'offline': 'bg-danger',
                    'error': 'bg-danger',
                    'warning': 'bg-warning text-dark'
                };

                return badgeMap[status?.toLowerCase()] || 'bg-secondary';
            },

            formatDate(dateString) {
                if (!dateString) return 'N/A';
                try {
                    return new Date(dateString).toLocaleString();
                } catch (error) {
                    return 'Invalid date';
                }
            },

            formatJSON(obj) {
                if (!obj) return 'No data available';
                try {
                    return JSON.stringify(obj, null, 2);
                } catch (error) {
                    return 'Invalid JSON';
                }
            }
        }));
    });
</script>
{% endblock %}