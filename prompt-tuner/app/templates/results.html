<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/evaluation.css') }}" rel="stylesheet">
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <!-- API Configuration -->
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>

    <!-- Utility Scripts -->
    <script src="{{ url_for('static', filename='js/base-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/display-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/validation-utils.js') }}"></script>
    
    <!-- Modular JavaScript Components -->
    <script src="{{ url_for('static', filename='js/data-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/array-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dynamic-workflow.js') }}"></script>
    
    <!-- Load modular JS files in dependency order -->
    <script src="{{ url_for('static', filename='js/json-response-builder.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chat-response-parser.js') }}"></script>
    <script src="{{ url_for('static', filename='js/prompt-evaluation-core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/prompt-evaluation-app.js') }}"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <div class="w-100 d-flex justify-content-between align-items-center">
                <a class="navbar-brand" href="../index.html" style="text-decoration: none;">
                    Results
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary btn-sm">
                    ‚Üê Back to Workflows
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" x-data="resultsApp()" x-init="init()">
        <div class="container">
            <!-- Header Section -->
            <div class="header-section text-center mb-5">
                <h1 class="evaluation-title" x-text="workflowName || 'Workflow Results'"></h1>
                <p class="evaluation-description">
                    <span x-text="workflowId"></span>
                    <span x-show="revisionId"> - Revision: <span x-text="revisionId"></span></span>
                </p>
            </div>

            <!-- Loading Section -->
            <div class="loading-section" x-show="isLoading" x-transition>
                <div class="text-center">
                    <h3 class="loading-title">Loading Results</h3>
                    
                    <!-- Single Loading Spinner -->
                    <div class="mt-4">
                        <div class="custom-spinner" role="status" aria-label="Loading"></div>
                        <p class="mt-3 text-muted">Please wait while we fetch your results...</p>
                    </div>
                </div>
            </div>

            <!-- Error Section -->
            <div class="alert alert-danger" x-show="error" x-transition>
                <h5 class="alert-heading">Error Loading Results</h5>
                <p class="mb-0" x-text="error"></p>
            </div>

            <!-- Results Section -->
            <div class="results-section" x-show="hasResults && !isLoading" x-transition>
                <div class="section-header mb-4 text-start">
                    <h3>Evaluation Results</h3>
                    <p class="text-muted">Complete workflow execution results and agent performance metrics</p>
                </div>

                <!-- Workflow Results -->
                <div class="workflow-results mb-5">
                    <div class="result-card">
                        <div class="result-content">
                            <div class="output-text" x-html="formatWorkflowOutput((results && results.workflowOutput) ? results.workflowOutput : '')"></div>
                        </div>
                    </div>
                </div>

                <!-- Agent Evaluations -->
                <div class="agent-evaluations mb-5">
                    <div class="section-header mb-4 text-start">
                        <h3>Agent Results & Performance</h3>
                        <p class="text-muted">Individual agent outputs and performance metrics for transparency and debugging</p>
                    </div>
                    
                    <!-- Prefer parsed agent responses when available -->
                    <template x-if="results && results.parsedAgentResponses && results.parsedAgentResponses.length > 0">
                        <div class="row g-4">
                            <template x-for="(agent, idx) in results.parsedAgentResponses" :key="agent.agent_name || idx">
                                <div class="col-12">
                                    <div class="agent-card" x-data="{ expanded: true }">
                                        <div class="agent-header d-flex justify-content-between align-items-start">
                                            <div class="d-flex align-items-center flex-wrap gap-2">
                                                <h5 class="mb-0" x-text="formatAgentName(agent.agent_name || 'Agent')"></h5>
                                                <template x-if="agent.completion_tokens || agent.prompt_tokens || agent.execution_ms">
                                                    <span class="agent-inline-metrics">
                                                        <span class="metric" x-show="agent.completion_tokens !== undefined">Completion tokens: <strong x-text="agent.completion_tokens"></strong></span>
                                                        <span class="metric ms-2" x-show="agent.prompt_tokens !== undefined">Prompt tokens: <strong x-text="agent.prompt_tokens"></strong></span>
                                                        <span class="metric ms-2" x-show="agent.execution_ms !== undefined">
                                                            Time:
                                                            <strong x-text="(agent.execution_ms / 1000).toFixed(3)"></strong><span> seconds (</span><span x-text="agent.execution_ms"></span><span> ms)</span>
                                                        </span>
                                                    </span>
                                                </template>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <button 
                                                    class="btn btn-sm btn-outline-secondary"
                                                    @click="expanded = !expanded"
                                                    :class="{ 'active': expanded }"
                                                >
                                                    <i class="bi" :class="expanded ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Agent Output (Expandable) -->
                                        <div class="agent-output" x-show="expanded" x-transition>
                                            <div class="output-header mb-2">
                                                <h6 class="mb-0">Agent Output:</h6>
                                            </div>
                                            <div class="output-content">
                                                <div class="output-text" x-text="agent.chat_response"></div>
                                            </div>
                                            <div class="output-actions mt-2">
                                                <button class="btn btn-sm btn-outline-primary" @click="copyAgentOutput(agent.chat_response)">
                                                    <i class="bi bi-clipboard"></i> Copy Output
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- Fallback to legacy agentResults structure if no parsed responses -->
                    <template x-if="!results || !results.parsedAgentResponses || results.parsedAgentResponses.length === 0">
                        <div class="row g-4">
                            <template x-for="agentResult in ((results && results.agentResults) ? results.agentResults : [])" :key="agentResult.agentName">
                                <div class="col-12">
                                    <div class="agent-card">
                                        <div class="agent-header d-flex justify-content-between align-items-start">
                                            <div>
                                                <h5 x-text="formatAgentName(agentResult.displayName || agentResult.agentName)"></h5>
                                                <p class="text-muted small mb-0" x-text="getAgentDescription(agentResult.agentName)"></p>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <button 
                                                    class="btn btn-sm btn-outline-secondary"
                                                    @click="agentResult.expanded = !agentResult.expanded"
                                                    :class="{ 'active': (agentResult.expanded ?? true) }"
                                                >
                                                    <i class="bi" :class="(agentResult.expanded ?? true) ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Agent Metrics Row -->
                                        <div class="agent-metrics-row d-flex flex-wrap gap-3 mb-3">
                                            <div class="metric-item">
                                                <span class="metric-label">Tokens:</span>
                                                <span class="metric-value" x-text="agentResult.tokensUsed.toLocaleString()"></span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Model:</span>
                                                <span class="metric-value" x-text="agentResult.model"></span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Time:</span>
                                                <span class="metric-value" x-text="agentResult.executionTime + 'ms'"></span>
                                            </div>
                                        </div>
                                        
                                        <!-- Agent Output (Expandable) -->
                                        <div class="agent-output" x-show="agentResult.expanded ?? true" x-transition>
                                            <div class="output-header mb-2">
                                                <h6 class="mb-0">Agent Output:</h6>
                                            </div>
                                            <div class="output-content">
                                                <div class="output-text" x-text="agentResult.output"></div>
                                            </div>
                                            <div class="output-actions mt-2">
                                                <button class="btn btn-sm btn-outline-primary" @click="copyAgentOutput(agentResult.output)">
                                                    <i class="bi bi-clipboard"></i> Copy Output
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- Action Buttons -->
                <div class="text-center mt-5">
                    <button class="btn btn-outline-primary me-3" @click="goToEvaluation()">
                        <i class="bi bi-arrow-left"></i>
                        Back to Evaluation
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    {% include '_footer.html' %}

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function resultsApp() {
            return {
                // URL parameters
                workflowId: '',
                revisionId: '',
                workflowName: '',
                
                // State
                isLoading: true,
                hasResults: false,
                error: null,
                results: null,

                init() {
                    // Get URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    this.workflowId = urlParams.get('id') || '';
                    this.revisionId = urlParams.get('revision_id') || '';
                    
                    if (!this.workflowId) {
                        this.error = 'No workflow ID provided in URL parameters';
                        this.isLoading = false;
                        return;
                    }

                    // Load results
                    this.loadResults();
                },

                async loadResults() {
                    try {
                        this.isLoading = true;
                        this.error = null;

                        // First, try to get results from sessionStorage (from recent evaluation)
                        const storedResults = sessionStorage.getItem(`evaluation_results_${this.workflowId}_${this.revisionId}`);
                        if (storedResults) {
                            try {
                                const data = JSON.parse(storedResults);
                                this.results = data;
                                this.workflowName = this.workflowId;
                                this.hasResults = true;
                                this.isLoading = false;
                                return;
                            } catch (parseError) {
                                console.warn('Failed to parse stored results:', parseError);
                            }
                        }

                        // Fallback: try to fetch from API endpoint (if implemented)
                        let endpoint = `/api/results/${this.workflowId}`;
                        if (this.revisionId) {
                            endpoint += `?revision_id=${this.revisionId}`;
                        }

                        const response = await fetch(endpoint);
                        
                        if (!response.ok) {
                            throw new Error(`Failed to load results: ${response.status} ${response.statusText}. Please run the evaluation again.`);
                        }

                        const data = await response.json();
                        this.results = data;
                        this.workflowName = data.workflowName || data.workflow?.name || this.workflowId;
                        this.hasResults = true;

                    } catch (error) {
                        console.error('Error loading results:', error);
                        this.error = error.message;
                    } finally {
                        this.isLoading = false;
                    }
                },

                formatWorkflowOutput(output) {
                    if (!output) return '<p class="text-muted">No output available</p>';
                    
                    // Basic HTML formatting - preserve line breaks and basic formatting
                    return output.replace(/\n/g, '<br>');
                },

                formatAgentName(name) {
                    if (!name) return 'Unknown Agent';
                    
                    // Convert snake_case or kebab-case to Title Case
                    return name
                        .replace(/[_-]/g, ' ')
                        .replace(/\b\w/g, l => l.toUpperCase());
                },

                getAgentDescription(agentName) {
                    // Provide default descriptions for common agent types
                    const descriptions = {
                        'chat_agent': 'Primary conversation agent',
                        'analysis_agent': 'Data analysis and processing',
                        'summary_agent': 'Content summarization',
                        'validation_agent': 'Input validation and checking'
                    };
                    
                    return descriptions[agentName] || 'Workflow processing agent';
                },

                copyAgentOutput(output) {
                    if (!output) return;
                    
                    navigator.clipboard.writeText(output).then(() => {
                        // You could show a toast notification here
                        console.log('Output copied to clipboard');
                    }).catch(err => {
                        console.error('Failed to copy output:', err);
                    });
                },

                downloadResults() {
                    if (!this.results) return;

                    const dataStr = JSON.stringify(this.results, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `results-${this.workflowId}-${this.revisionId || 'latest'}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                goToEvaluation() {
                    let evaluationUrl = `/evaluate`;
                    if (this.workflowId) {
                        evaluationUrl += `?workflow=${encodeURIComponent(this.workflowId)}`;
                    }
                    window.location.href = evaluationUrl;
                }
            };
        }
    </script>
</body>
</html>